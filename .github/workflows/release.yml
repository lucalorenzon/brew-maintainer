name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
      # Checkout the current repo (brew-maintainer)
      - name: Checkout source repository
        uses: actions/checkout@v4

      # Extract repo name (for later)
      - name: Set up environment variables
        id: vars
        run: |
          echo "REPO_NAME=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_ENV
          echo "OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)" >> $GITHUB_ENV
          echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      # Build your Rust binary
      - name: Build Rust binary
        run: |
          cargo build --release
          mkdir -p dist
          cp target/release/brew-maintainer dist/

      # Create SHA256 checksum
      - name: Generate SHA256SUMS
        run: |
          cd dist
          shasum -a 256 brew-maintainer > SHA256SUMS.txt
          cd ..

      # Prepare Formula template
      - name: Prepare Homebrew formula
        run: |
          mkdir -p dist
          cp FormulaTemplate/brew-maintainer.rb dist/brew-maintainer.rb

          URL="https://github.com/${OWNER}/${REPO_NAME}/archive/${VERSION}.tar.gz"
          SHA=$(awk '{print $1}' dist/SHA256SUMS.txt)

          # Replace placeholders inside the formula template
          sed -i.bak "s|url \".*\"|url \"${URL}\"|" dist/brew-maintainer.rb
          sed -i.bak "s|sha256 \".*\"|sha256 \"${SHA}\"|" dist/brew-maintainer.rb
          sed -i.bak "s|version \".*\"|version \"${VERSION}\"|" dist/brew-maintainer.rb
          sed -i.bak "s|homepage \".*\"|homepage \"https://github.com/${OWNER}/${REPO_NAME}\"|" dist/brew-maintainer.rb
          rm -f dist/*.bak

      # Publish release to GitHub
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/brew-maintainer
            dist/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Clone the tap repo using PAT
      - name: Push updated formula to tap
        env:
          TAP_REPO: homebrew-tap
          OWNER: ${{ env.OWNER }}
          VERSION: ${{ env.VERSION }}
          REPO_NAME: ${{ env.REPO_NAME }}
          GITHUB_ACTOR: ${{ github.actor }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -e
          echo "üîß Cloning tap repository..."
          cd "$GITHUB_WORKSPACE"

          # Authenticated clone
          git clone "https://${GITHUB_ACTOR}:${HOMEBREW_TAP_TOKEN}@github.com/${OWNER}/${TAP_REPO}.git"
          cd "${TAP_REPO}"

          mkdir -p Formula

          echo "üì¶ Copying updated formula..."
          cp ../dist/brew-maintainer.rb Formula/brew-maintainer.rb

          echo "üìù Configuring Git..."
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add Formula/brew-maintainer.rb
          git commit -m "Update brew-maintainer formula to ${VERSION}" || echo "No changes to commit"

          echo "üöÄ Pushing to tap repo..."
          git push "https://${GITHUB_ACTOR}:${HOMEBREW_TAP_TOKEN}@github.com/${OWNER}/${TAP_REPO}.git" main
